pipeline {
    agent any

	options {
		ansiColor('gnome-terminal')
	}

    environment {
        PWD = sh 'pwd'
        TMP_FOLDER = "/var/tmp/jenkins/build-`date +%s%N`"
    }

    stages {
        stage ('SetupEnvironment') {
            steps {
                echo ">>> Setting up the environment..."
                echo ">>> GIT_REPO: " + params.gitRepoUrl
                echo ">>> GIT_BRANCH: " + params.branchName
                echo ">>> Temporary folder: " + ${env.TMP_FOLDER}
                echo ">>> " + $PWD

                script {
                    env.GIT_REPO = params.gitRepoUrl
                    env.GIT_BRANCH = params.branchName
                }
            }
        }

        stage ('Checkout') {
            steps {
                echo ">>> Checking out the source..."
                sh """
                    mkdir -p ${env.TMP_FOLDER} && cd ${env.TMP_FOLDER}
                    git clone ${env.GIT_REPO_URL} && cd `basename ${env.GIT_REPO_URL} | sed 's/.git//'`
                    git checkout ${env.GIT_BRANCH}
                """
            }
        }

        stage ('Build') {
            steps {
                echo ">>> Building... "
                sh "mvn clean compile test package install"
            }
        }

        stage('Cleanup') {
            steps {
                echo ">>> Cleaning up temporary folders..."
                sh """
                    cd /var/tmp
                    rm ${env.TMP_FOLDER} -R
                """
            }
        }
    }
}