pipeline {
    agent any

	options {
		ansiColor('gnome-terminal')
	}

    environment {
        PWD = "`pwd`"
        TMP_FOLDER = "/var/tmp/jenkins/build-`date +%s%N`"
        GIT_REPO_URL = "params.gitRepoUrl"
        GIT_BRANCH = "params.branchName"
    }

    stages {
        stage ('SetupEnvironment') {
            steps {
                echo ">>> Setting up the environment..."
                echo ">>> GIT_REPO: params.gitRepoUrl"
                echo ">>> GIT_BRANCH: {$GIT_BRANCH}"
                echo ">>> Temporary folder: {$TMP_FOLDER}"
                echo ">>> ${PWD}"
            }
        }

        stage ('Checkout') {
            steps {
                echo ">>> Checking out the source..."
                sh """
                    mkdir -p ${TMP_FOLDER} && cd ${TMP_FOLDER}
                    git clone ${GIT_REPO_URL} && cd `basename ${GIT_REPO_URL} | sed 's/.git//'`
                    git checkout ${GIT_BRANCH}
                """
            }
        }

        stage ('Build') {
            steps {
                echo ">>> Building... "
                sh "mvn clean compile test package install"
            }
        }

        stage('Cleanup') {
            steps {
                echo ">>> Cleaning up temporary folders..."
                sh """
                    cd /var/tmp
                    rm ${TMP_FOLDER} -R
                """
            }
        }
    }
}